<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktdsuniversity.edu.pms.project.dao.ProjectDao">

    <resultMap type="com.ktdsuniversity.edu.pms.project.vo.ProjectVO"
               id="projectVOMap"
               autoMapping="true">
        <id column="PRJ_ID" property="prjId"/>
        <association property="prjStsCode"
                     javaType="com.ktdsuniversity.edu.pms.commoncode.vo.CommonCodeVO">
            <id column="CMCD_ID" property="cmcdId"/>
            <result column="CMCD_NAME" property="cmcdName"/>
        </association>
        <association property="deptVO"
                     javaType="com.ktdsuniversity.edu.pms.department.vo.DepartmentVO">
            <id column="DEPT_ID" property="deptId"/>
            <result column="DEPT_NAME" property="deptName"/>
        </association>
    </resultMap>

    <resultMap type="com.ktdsuniversity.edu.pms.project.vo.ProjectVO"
               id="projectTeamListMap"
               autoMapping="true">
        <id column="PRJ_ID" property="prjId"/>
        <association property="prjStsCode"
                     javaType="com.ktdsuniversity.edu.pms.commoncode.vo.CommonCodeVO">
            <id column="CMCD_ID" property="cmcdId"/>
            <result column="CMCD_NAME" property="cmcdName"/>
        </association>
        <association property="deptVO"
                     javaType="com.ktdsuniversity.edu.pms.department.vo.DepartmentVO">
            <id column="DEPT_ID" property="deptId"/>
            <result column="DEPT_NAME" property="deptName"/>
        </association>
        <collection property="projectTeammateList"
                    ofType="com.ktdsuniversity.edu.pms.project.vo.ProjectTeammateVO"
                    column="PRJ_ID">
            <id column="PRJ_TM_ID" property="prjTmId"/>
            <result column="TM_ID" property="tmId"/>
            <result column="ROLE" property="role"/>
            <association property="employeeVO"
                         javaType="com.ktdsuniversity.edu.pms.employee.vo.EmployeeVO">
                <id column="EMP_ID" property="empId"/>
                <result column="EMP_NAME" property="empName"/>
            </association>
        </collection>
    </resultMap>

    <select id="selectAllProject"
            resultMap="projectVOMap">
        <!--            resultMap="projectVOMap">-->
        SELECT P.PRJ_ID
	         , P.PRJ_NAME
	         , P.CLNT_INFO
	         , P.DEPT_ID
	         , P.PRJ_STS
	         , P.STRT_DT
	         , P.END_DT
	         , P.DEL_YN
	         , P.REQ_YN
	         , P.IS_YN
	         , P.KNL_YN
	         , P.QA_YN
	         , P.OUT_YN
	         , P.CRTR_ID
	         , P.CRT_DT
	         , P.MDFR_ID
	         , P.MDF_DT
	         , C.CMCD_NAME
	         , D.DEPT_NAME
        FROM PROJECT P
        INNER JOIN DEPARTMENT D
        ON P.DEPT_ID = D.DEPT_ID
        INNER JOIN COMMON_CODE C
        ON P.PRJ_STS = C.CMCD_ID
        WHERE P.DEL_YN = 'N'
        ORDER BY P.CRT_DT DESC
    </select>

    <select id="selectAllProjectCount">
        SELECT COUNT(1)
        FROM PROJECT
        WHERE DEL_YN = 'N'
    </select>

    <select id="searchBoard"
            parameterType="com.ktdsuniversity.edu.pms.project.vo.SearchProjectVO"
            resultMap="projectVOMap">
        <include refid="Common.pagenate_header" />
        SELECT P.PRJ_ID
        , P.PRJ_NAME
        , P.CLNT_INFO
        , P.DEPT_ID
        , P.PRJ_STS
        , P.STRT_DT
        , P.END_DT
        , P.DEL_YN
        , P.REQ_YN
        , P.IS_YN
        , P.KNL_YN
        , P.QA_YN
        , P.OUT_YN
        , P.CRTR_ID
        , P.CRT_DT
        , P.MDFR_ID
        , P.MDF_DT
        , C.CMCD_NAME
        , D.DEPT_NAME
        FROM PROJECT P
        INNER JOIN DEPARTMENT D
        ON P.DEPT_ID = D.DEPT_ID
        INNER JOIN COMMON_CODE C
        ON P.PRJ_STS = C.CMCD_ID
        WHERE P.DEL_YN = 'N'
        AND D.DEL_YN = 'N'
        AND C.DEL_YN = 'N'
        <if test='searchStatus != null and searchStatus != ""'>
            AND P.PRJ_STS = #{searchStatus}
        </if>
        <if test='searchKeyword != null and searchKeyword != ""'>
            <choose>
                <when test='searchType == "project"'>
                    AND P.PRJ_NAME LIKE '%' ||  #{searchKeyword} || '%'
                </when>
                <when test='searchType == "client"'>
                    AND P.CLNT_INFO LIKE '%' ||  #{searchKeyword} || '%'
                </when>
                <when test='searchType == "department"'>
                    AND D.DEPT_NAME LIKE '%' ||  #{searchKeyword} || '%'
                </when>
            </choose>
        </if>
        ORDER BY P.CRT_DT DESC
        <include refid="Common.pagenate_footer" />
    </select>

    <select id="searchProjectCount"
            parameterType="com.ktdsuniversity.edu.pms.project.vo.SearchProjectVO"
            resultType="_int">
        SELECT COUNT(1)
        FROM PROJECT P
        INNER JOIN DEPARTMENT D
        ON P.DEPT_ID = D.DEPT_ID
        INNER JOIN COMMON_CODE C
        ON P.PRJ_STS = C.CMCD_ID
        WHERE P.DEL_YN = 'N'
        AND D.DEL_YN = 'N'
        AND C.DEL_YN = 'N'
        <if test='searchStatus != null and searchStatus != ""'>
            AND P.PRJ_STS = #{searchStatus}
        </if>
        <if test='searchKeyword != null and searchKeyword != ""'>
            <choose>
                <when test='searchType == "project"'>
                    AND P.PRJ_NAME LIKE '%' ||  #{searchKeyword} || '%'
                </when>
                <when test='searchType == "client"'>
                    AND P.CLNT_INFO LIKE '%' ||  #{searchKeyword} || '%'
                </when>
                <when test='searchType == "department"'>
                    AND D.DEPT_NAME LIKE '%' ||  #{searchKeyword} || '%'
                </when>
            </choose>
        </if>
    </select>

    <select id="findById"
            parameterType="String"
            resultMap="projectTeamListMap">
        SELECT P.PRJ_ID
        , P.PRJ_NAME
        , P.CLNT_INFO
        , P.DEPT_ID
        , P.PRJ_STS
        , P.STRT_DT
        , P.END_DT
        , P.DEL_YN
        , P.REQ_YN
        , P.IS_YN
        , P.KNL_YN
        , P.QA_YN
        , P.OUT_YN
        , P.CRTR_ID
        , P.CRT_DT
        , P.MDFR_ID
        , P.MDF_DT
        , C.CMCD_NAME
        , D.DEPT_NAME
        , PT."ROLE"
        , E.EMP_NAME
        FROM (SELECT PRJ_ID
        , PRJ_NAME
        , CLNT_INFO
        , DEPT_ID
        , PRJ_STS
        , STRT_DT
        , END_DT
        , DEL_YN
        , REQ_YN
        , IS_YN
        , KNL_YN
        , QA_YN
        , OUT_YN
        , CRTR_ID
        , CRT_DT
        , MDFR_ID
        , MDF_DT
        FROM PROJECT
        WHERE PRJ_ID = #{_parameter}
        ) P
        LEFT JOIN DEPARTMENT D
        ON P.DEPT_ID = D.DEPT_ID
        LEFT JOIN COMMON_CODE C
        ON P.PRJ_STS = C.CMCD_ID
        LEFT JOIN PROJECT_TEAMMATE PT
        ON P.PRJ_ID = PT.PRJ_ID
        LEFT JOIN EMPLOYEE E
        ON PT.TM_ID = E.EMP_ID
        WHERE P.DEL_YN = 'N'
    </select>

    <insert id="insertNewProject"
            parameterType="com.ktdsuniversity.edu.pms.project.vo.CreateProjectVO"
            useGeneratedKeys="true" keyProperty="prjId" keyColumn="PRJ_ID">
        INSERT INTO PROJECT
        (PRJ_ID,
        PRJ_NAME,
        CLNT_INFO,
        DEPT_ID,
        PRJ_STS,
        STRT_DT,
        END_DT,
        DEL_YN,
        <if test='reqYn != null and reqYn != ""'>
        REQ_YN,
        IS_YN,
        KNL_YN,
        QA_YN,
        </if>
        OUT_YN,
        CRTR_ID)
        VALUES
        (('PRJ_' || TO_CHAR(SYSDATE, 'YYMMDD') || '_' || LPAD(SEQ_PROJECT_PK.NEXTVAL, 6, '0')),
        #{prjName},
        #{clntInfo},
        #{deptId},
        '401',
        TO_DATE(#{strtDt}, 'YYYY-MM-DD'),
        TO_DATE(#{endDt}, 'YYYY-MM-DD'),
        'N',
        <if test='reqYn != null and reqYn != ""'>
            #{reqYn},
            <choose>
                <when test='isYn == null and isYn != ""'> 'N',
                </when>
                <otherwise>#{isYn},
                </otherwise>
            </choose>
            <choose>
                <when test='knlYn == null and knlYn != ""'> 'N',
                </when>
                <otherwise>#{knlYn},
                </otherwise>
            </choose>
            <choose>
                <when test='qaYn == null and qaYn != ""'> 'N',
                </when>
                <otherwise>#{qaYn},
                </otherwise>
            </choose>
        </if>
        #{outYn},
        #{crtrId})
    </insert>

    <insert id="insertNewPm"
            parameterType="com.ktdsuniversity.edu.pms.project.vo.ProjectTeammateVO">
        INSERT INTO PROJECT_TEAMMATE
        (PRJ_TM_ID,
        PRJ_ID,
        TM_ID,
        ROLE,
        DEL_YN)
        VALUES
        (('PRJ_TM_' || TO_CHAR(SYSDATE, 'YYMMDD') || '_' || LPAD(SEQ_PROJECT_TEAMMATE_PK.NEXTVAL, 6, '0')),
        #{prjId},
        #{tmId},
        #{role},
        'N')
    </insert>

    <update id="deleteById"
            parameterType="String">
        UPDATE PROJECT
        SET DEL_YN = 'Y',
        MDF_DT = SYSDATE
        WHERE PRJ_ID = #{_parameter}
    </update>
</mapper>